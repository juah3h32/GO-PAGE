---
/* src/components/AudioVisualizer.astro */
---

<div id="audio-control" class="audio-visualizer" title="Pausar / Reproducir">
  <svg viewBox="0 0 100 40" preserveAspectRatio="xMidYMid slice">
    <line x1="-50" y1="20" x2="150" y2="20" 
          stroke="#FF4500" 
          stroke-width="2" 
          opacity="0.5" />

    <g class="wave-height-control">
        <path class="wave-moving" 
              fill="none" 
              d="M0 20 C 20 0, 30 0, 50 20 C 70 40, 80 40, 100 20 C 120 0, 130 0, 150 20 C 170 40, 180 40, 200 20" />
    </g>
  </svg>
</div>

<script>
  // Definición de tipos
  declare global {
    interface Window {
      _globalBgMusic?: HTMLAudioElement;
      _globalClickSound?: HTMLAudioElement;
      playGlobalClick: () => void;
    }
  }

  // --- INICIALIZACIÓN ---
  // Se ejecuta en carga inicial y en navegación por View Transitions
  document.addEventListener('astro:page-load', initAudioSystem);
  
  // Respaldo para carga inicial normal
  if (document.readyState === 'complete') {
     initAudioSystem();
  } else {
     document.addEventListener('DOMContentLoaded', initAudioSystem);
  }

  function initAudioSystem() {
    const btn = document.getElementById('audio-control');
    if (!btn) return;

    // 1. CREAR AUDIO SINGLETON (Solo una vez)
    if (!window._globalBgMusic) {
      window._globalBgMusic = new Audio("/FX/ambient.mp3"); // Asegura que la ruta sea correcta
      window._globalBgMusic.loop = true;
      window._globalBgMusic.volume = 0.3;
    }

    if (!window._globalClickSound) {
      window._globalClickSound = new Audio("/FX/Scan.wav");
      window._globalClickSound.volume = 0.5;
    }

    // 2. LEER PREFERENCIA GUARDADA (La clave para que sea global)
    // Estado por defecto: 'playing'
    const savedState = localStorage.getItem('audioState') || 'playing';

    // 3. APLICAR ESTADO INICIAL
    const bgMusic = window._globalBgMusic;

    if (savedState === 'paused') {
        // Si el usuario lo pausó antes, aseguramos que esté pausado visual y auditivamente
        bgMusic.pause();
        btn.classList.add('is-paused');
    } else {
        // Si debería sonar, intentamos reproducir
        // Nota: Los navegadores pueden bloquear esto si no ha habido interacción previa
        btn.classList.remove('is-paused');
        const playPromise = bgMusic.play();
        if (playPromise !== undefined) {
            playPromise.catch(() => {
                // Si el navegador bloquea el autoplay, lo marcamos como pausado visualmente
                // hasta que el usuario haga clic.
                console.log("Esperando interacción del usuario para reproducir audio.");
                btn.classList.add('is-paused');
            });
        }
    }

    // 4. MANEJAR CLIC (Toggle)
    // Clonamos para eliminar listeners viejos en navegaciones
    const newBtn = btn.cloneNode(true) as HTMLElement;
    btn.parentNode?.replaceChild(newBtn, btn);

    newBtn.addEventListener('click', () => {
      // Efecto de sonido al click
      if (window._globalClickSound) {
          window._globalClickSound.currentTime = 0;
          window._globalClickSound.play().catch(() => {});
      }

      if (bgMusic.paused) {
        // --- ACTIVAR ---
        bgMusic.play();
        newBtn.classList.remove('is-paused');
        localStorage.setItem('audioState', 'playing'); // GUARDAR DECISIÓN
      } else {
        // --- DETENER ---
        bgMusic.pause();
        newBtn.classList.add('is-paused');
        localStorage.setItem('audioState', 'paused'); // GUARDAR DECISIÓN
      }
    });

    // 5. HELPER PARA INTERACCIÓN INICIAL (Desbloqueo)
    // Si el audio debía sonar pero el navegador lo bloqueó, al primer clic en CUALQUIER lado, intentamos activarlo
    const unlockAudio = () => {
      if (localStorage.getItem('audioState') !== 'paused' && bgMusic.paused) {
         bgMusic.play().catch(() => {});
         // Sincronizar UI si se logra reproducir
         if(!bgMusic.paused) {
             const currentBtn = document.getElementById('audio-control');
             if(currentBtn) currentBtn.classList.remove('is-paused');
         }
      }
      document.removeEventListener('click', unlockAudio);
      document.removeEventListener('keydown', unlockAudio);
    };

    document.addEventListener('click', unlockAudio);
    document.addEventListener('keydown', unlockAudio);
  }

  // Exportar función global para efectos de click externos
  window.playGlobalClick = () => {
    if (window._globalClickSound) {
        // Solo suena si el usuario NO ha pausado la música global (opcional)
        // O quita el if si quieres que los efectos suenen siempre.
        if (localStorage.getItem('audioState') !== 'paused') {
            window._globalClickSound.currentTime = 0;
            window._globalClickSound.play().catch(() => {});
        }
    }
  };
</script>

<style>
  /* === CONTENEDOR === */
  .audio-visualizer {
    /* Posición manejada por el padre o aquí mismo si es global */
    width: 80px;
    height: 40px;
    cursor: pointer;
    overflow: hidden;
    transition: opacity 0.3s ease;
    /* Para debug: background: rgba(0,0,0,0.1); */
  }

  .audio-visualizer:hover {
    opacity: 0.8;
  }

  /* === ANIMACIÓN DE LA ONDA === */
  .wave-height-control {
    transform-origin: center 20px; 
    transform: scaleY(1); 
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .wave-moving {
    stroke: #FB670B;
    stroke-width: 3;
    stroke-linecap: round;
    animation: flowWave 1s linear infinite;
  }

  @keyframes flowWave {
    0% { transform: translateX(0); }
    100% { transform: translateX(-100px); }
  }

  /* === ESTADO PAUSADO === */
  /* Cuando tiene la clase .is-paused, aplastamos la onda y paramos la animación */
  :global(.audio-visualizer.is-paused) .wave-height-control {
    transform: scaleY(0.05); /* Casi plana */
  }

  :global(.audio-visualizer.is-paused) .wave-moving {
    opacity: 0.5;
    animation-play-state: paused; 
  }
</style>