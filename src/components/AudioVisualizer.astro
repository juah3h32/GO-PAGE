---
/* AudioVisualizer.astro - El Gestor Maestro de Audio */
---

<div id="audio-control" class="audio-visualizer" title="Silenciar / Reproducir">
  <svg viewBox="0 0 100 40" preserveAspectRatio="xMidYMid slice">
    <line x1="-50" y1="20" x2="150" y2="20" 
          stroke="#FF4500" 
          stroke-width="2" 
          opacity="0.5" />

    <g class="wave-height-control">
        <path class="wave-moving" 
              fill="none" 
              d="M0 20 C 20 0, 30 0, 50 20 C 70 40, 80 40, 100 20 C 120 0, 130 0, 150 20 C 170 40, 180 40, 200 20" />
    </g>
  </svg>
</div>

<script>
  // Definición de tipos para TypeScript
  declare global {
    interface Window {
      _globalBgMusic?: HTMLAudioElement;
      _globalClickSound?: HTMLAudioElement;
      _isGlobalMuted?: boolean; // Guardamos el estado del mute globalmente
      playGlobalClick: () => void;
    }
  }

  // --- LÓGICA DE INICIALIZACIÓN (Se ejecuta en cada navegación) ---
  document.addEventListener('astro:page-load', () => {
    initAudioSystem();
  });

  // Si no usas View Transitions, esto asegura que corra la primera vez
  if (document.readyState === 'complete') {
     initAudioSystem();
  } else {
     document.addEventListener('DOMContentLoaded', initAudioSystem);
  }

  function initAudioSystem() {
    const audioControl = document.getElementById('audio-control');
    if (!audioControl) return; // Si no hay botón en esta página, salimos.

    // 1. SINGLETON: Crear los audios SOLO si no existen en window
    if (!window._globalBgMusic) {
      window._globalBgMusic = new Audio("/FX/ambient.mp3");
      window._globalBgMusic.loop = true;
      window._globalBgMusic.volume = 0.3;
    }

    if (!window._globalClickSound) {
      window._globalClickSound = new Audio("/FX/Scan.wav");
      window._globalClickSound.volume = 0.5;
    }

    // Inicializar estado de mute si no existe
    if (typeof window._isGlobalMuted === 'undefined') {
        window._isGlobalMuted = false;
    }

    // 2. SINCRONIZAR UI ACTUAL CON EL ESTADO REAL
    // Esto es vital: Si vienes de otra página y ya estaba muteado, 
    // el botón nuevo debe reflejarlo.
    updateMuteState(window._isGlobalMuted);

    // 3. EVENT LISTENER DEL BOTÓN
    // Primero removemos para evitar duplicados si el script corre dos veces
    const newControl = audioControl.cloneNode(true) as HTMLElement;
    audioControl.parentNode?.replaceChild(newControl, audioControl);
    
    newControl.addEventListener('click', () => {
      // Invertir estado
      window._isGlobalMuted = !window._isGlobalMuted;
      updateMuteState(window._isGlobalMuted);
    });

    // 4. INICIADOR DE AUTOPLAY (Hack para navegadores)
    const startAudio = () => {
      if (window._globalBgMusic && window._globalBgMusic.paused && !window._isGlobalMuted) {
        window._globalBgMusic.play().catch(() => {
            // Si falla el autoplay, no hacemos nada, esperamos siguiente click
        });
      }
      // Limpiamos el evento una vez activado
      document.removeEventListener('click', startAudio);
      document.removeEventListener('keydown', startAudio);
    };

    document.addEventListener('click', startAudio);
    document.addEventListener('keydown', startAudio);
  }

  // Función auxiliar para aplicar el estado de Mute
  function updateMuteState(isMuted: boolean) {
    const btn = document.getElementById('audio-control');
    const bgMusic = window._globalBgMusic;
    const clickSound = window._globalClickSound;

    // Aplicar a los audios
    if (bgMusic) bgMusic.muted = isMuted;
    if (clickSound) clickSound.muted = isMuted;

    // Aplicar al botón (Visual)
    if (btn) {
        if (isMuted) {
            btn.classList.add('muted');
        } else {
            btn.classList.remove('muted');
            // Intentar reproducir si no está muteado y está pausado
            if (bgMusic && bgMusic.paused) {
                bgMusic.play().catch(() => {});
            }
        }
    }
  }

  // 5. EXPORTAR FUNCIÓN GLOBAL (Para usar en otros componentes)
  window.playGlobalClick = () => {
    if (window._globalClickSound && !window._globalClickSound.muted) {
      window._globalClickSound.currentTime = 0;
      window._globalClickSound.play().catch(e => console.error(e));
    }
  };
</script>

<style>
  /* === ESTILOS DEL VISUALIZADOR === */
  .audio-visualizer {
    position: fixed;
    bottom: 30px;
    right: 96px; /* Ajusta según tu diseño */
    width: 80px;
    height: 40px;
    z-index: 9999; /* Z-index alto para asegurar click */
    cursor: pointer;
    overflow: hidden;
    transition: opacity 0.3s ease;
    /* Fondo opcional para depuración si no lo ves */
    /* background: rgba(0,0,0,0.2); */ 
  }

  .audio-visualizer:hover {
    opacity: 0.8;
  }

  /* CONTROL DE ALTURA */
  .wave-height-control {
    transform-origin: center 20px; 
    transform: scaleY(1); 
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* MOVIMIENTO */
  .wave-moving {
    stroke: #FB670B;
    stroke-width: 3;
    stroke-linecap: round;
    animation: flowWave 1s linear infinite;
  }

  @keyframes flowWave {
    0% { transform: translateX(0); }
    100% { transform: translateX(-100px); }
  }

  /* === ESTADO: MUTEADO === */
  :global(.audio-visualizer.muted) .wave-height-control {
    transform: scaleY(0.1); 
  }

  :global(.audio-visualizer.muted) .wave-moving {
    opacity: 0.3;
    animation-play-state: paused; 
  }
</style>