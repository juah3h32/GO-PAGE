---
/* src/components/BuyButton.astro */
---

<button id="truck-cta-btn" class="cta-btn">
  <span class="default">Comprar</span>
  <span class="success">
    Redirigiendo...
    <svg viewBox="0 0 12 10">
      <polyline points="1.5 6 4.5 9 10.5 1"></polyline>
    </svg>
  </span>
  <div class="truck">
    <div class="wheel"></div>
    <div class="back">
      <img src="/images/logo.png" alt="Logo Grupo Ortiz" class="truck-logo" />
    </div>
    <div class="front"></div>
    <div class="box"></div>
  </div>
</button>

<script>
  // @ts-nocheck 
  // (La línea de arriba desactiva chequeos estrictos de TS si te dan muchos problemas, 
  // pero el código de abajo está corregido para funcionar sin ella).

  document.addEventListener("DOMContentLoaded", () => {
    const button = document.getElementById("truck-cta-btn");
    
    // Si no hay botón, paramos todo.
    if (!button) return;

    // 1. DEFINIR VARIABLES FUERA (Para asegurar que existen)
    const truck = button.querySelector(".truck");
    const box = button.querySelector(".box");

    // 2. VALIDACIÓN DE SEGURIDAD (Si falta el camión o la caja, no hacemos nada)
    if (!truck || !box) {
        console.error("Error: Elementos del camión no encontrados en el DOM");
        return;
    }

    // Función de reset
    const resetBtn = () => {
      button.classList.remove("animation", "done");
      gsap.set(truck, { x: 4 });
      gsap.set(button, {
        "--progress": 0,
        "--hx": 0,
        "--bx": 0,
        "--box-s": 0.5,
        "--box-o": 0,
        "--truck-y": 0,
        "--truck-y-n": -26,
      });
      gsap.set(box, { x: -24, y: -6 });
    };

    button.addEventListener("click", (e) => {
      e.preventDefault();

      // 3. CORRECCIÓN DEL DATASET
      // Buscamos el elemento y lo forzamos a ser HTMLElement para leer dataset
      const activeThumb = document.querySelector(".thumb-item.active");
      
      // Obtenemos el link con seguridad (si no hay thumb activo, usa #)
      let targetUrl = "#";
      if (activeThumb && activeThumb instanceof HTMLElement) {
          targetUrl = activeThumb.dataset.link || "#";
      }

      if (!button.classList.contains("done")) {
        if (!button.classList.contains("animation")) {
          button.classList.add("animation");

          // Secuencia de animación GSAP
          gsap.to(button, { "--box-s": 1, "--box-o": 1, duration: 0.3, delay: 0.5 });
          gsap.to(box, { x: 0, duration: 0.4, delay: 0.7 });
          gsap.to(button, { "--hx": -5, "--bx": 50, duration: 0.18, delay: 0.92 });
          gsap.to(box, { y: 0, duration: 0.1, delay: 1.15 });
          gsap.set(button, { "--truck-y": 0, "--truck-y-n": -26 });

          gsap.to(button, {
            "--truck-y": 1,
            "--truck-y-n": -25,
            duration: 0.2,
            delay: 1.25,
            onComplete() {
              gsap.timeline({
                  onComplete() {
                    button.classList.add("done");

                    // 4. LÓGICA DE REDIRECCIÓN FINAL
                    setTimeout(() => {
                      if (targetUrl && targetUrl !== "#" && targetUrl !== "undefined") {
                        window.location.href = targetUrl;
                      } else {
                        console.log("Modo Demo o sin Link asignado. Reseteando...");
                        resetBtn();
                      }
                    }, 500);
                  },
                })
                .to(truck, { x: 0, duration: 0.4 })
                .to(truck, { x: 40, duration: 1 })
                .to(truck, { x: 20, duration: 0.6 })
                .to(truck, { x: 96, duration: 0.4 });

              gsap.to(button, {
                "--progress": 1,
                duration: 2.4,
                ease: "power2.in",
              });
            },
          });
        }
      }
    });
  });
</script>

<style>
  /* MISMOS ESTILOS QUE YA TENÍAS, SIN CAMBIOS AQUÍ */
  .cta-btn {
    --color: #fff;
    --background: #2b3044;
    --tick: #16bf78;
    --base: #0d0f18;
    --wheel: #1b1b1b;
    --wheel-inner: #646464;
    --street: #646b8c;
    --street-fill: #404660;
    --truck-body: #f4f6f8;
    --truck-body-shadow: #d0d4d8;
    --window: #2a2d35;
    --bumper: #333;
    --box: #dcb97a;
    --box-shadow: #b89b66;

    padding: 12px 0;
    width: 172px;
    cursor: pointer;
    text-align: center;
    position: relative;
    border: none;
    outline: none;
    color: var(--color);
    background: var(--background);
    border-radius: var(--br, 15px);
    -webkit-appearance: none;
    -webkit-tap-highlight-color: transparent;
    transform-style: preserve-3d;
    transform: rotateX(var(--rx, 0deg)) translateZ(0);
    transition: transform 0.5s, border-radius 0.3s linear var(--br-d, 0s);
    margin-top: 20px;
  }

  .cta-btn:before,
  .cta-btn:after {
    content: "";
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 6px;
    display: block;
    background: var(--b, var(--street));
    transform-origin: 0 100%;
    transform: rotateX(90deg) scaleX(var(--sy, 1));
  }
  .cta-btn:after {
    --sy: var(--progress, 0);
    --b: var(--street-fill);
  }

  .cta-btn .default,
  .cta-btn .success {
    display: block;
    font-weight: 500;
    font-size: 14px;
    line-height: 24px;
    opacity: var(--o, 1);
    transition: opacity 0.3s;
  }

  .cta-btn .success {
    --o: 0;
    position: absolute;
    top: 12px;
    left: 0;
    right: 0;
  }

  .cta-btn .success svg {
    width: 12px;
    height: 10px;
    display: inline-block;
    vertical-align: top;
    fill: none;
    margin: 7px 0 0 12px;
    stroke: var(--tick);
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
    stroke-dasharray: 16px;
    stroke-dashoffset: var(--offset, 16px);
    transition: stroke-dashoffset 0.4s ease 0.45s;
  }

  /* --- CAMIÓN --- */
  .cta-btn .truck {
    position: absolute;
    width: 80px;
    height: 28px;
    transform: rotateX(90deg) translate3d(var(--truck-x, 4px), calc(var(--truck-y-n, -26) * 1px), 12px);
  }

  .cta-btn .truck:before,
  .cta-btn .truck:after {
    content: "";
    position: absolute;
    bottom: -6px;
    width: 9px;
    height: 9px;
    border-radius: 50%;
    z-index: 2;
    box-shadow: inset 0 0 0 2px var(--wheel), inset 0 0 0 3px var(--wheel-inner);
    background: #333;
    transform: translateY(calc(var(--truck-y) * -1px)) translateZ(0);
  }

  .cta-btn .truck:before { left: 6px; }
  .cta-btn .truck:after { left: 52px; }

  .cta-btn .truck .wheel {
    position: absolute;
    bottom: -6px;
    left: 70px;
    width: 9px;
    height: 9px;
    border-radius: 50%;
    z-index: 2;
    box-shadow: inset 0 0 0 2px var(--wheel), inset 0 0 0 3px var(--wheel-inner);
    background: #333;
    transform: translateY(calc(var(--truck-y) * -1px)) translateZ(0);
  }

  .cta-btn .truck .front,
  .cta-btn .truck .back,
  .cta-btn .truck .box {
    position: absolute;
  }

  .cta-btn .truck .back .truck-logo {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 45%;
    height: auto;
    object-fit: contain;
    z-index: 10;
    opacity: 0.9;
    pointer-events: none;
  }

  .cta-btn .truck .back {
    left: 0;
    bottom: 0;
    z-index: 1;
    width: 53px;
    height: 28px;
    border-radius: 2px;
    background: var(--truck-body);
    border: 1px solid #eee;
  }

  .cta-btn .truck .back:before {
    content: "";
    position: absolute;
    right: -2px;
    top: 2px;
    width: 4px;
    height: 14px;
    background: var(--truck-body-shadow);
    border-radius: 0 2px 2px 0;
  }
  .cta-btn .truck .back:after {
    content: "";
    position: absolute;
    left: 14px;
    right: 6px;
    bottom: -2px;
    height: 4px;
    background: var(--bumper);
    border-radius: 2px;
  }

  .cta-btn .truck .front {
    left: 56px;
    bottom: 0px;
    height: 28px;
    width: 24px;
    background: var(--truck-body);
    border-radius: 4px 10px 4px 4px;
  }

  .cta-btn .truck .front:before {
    content: "";
    position: absolute;
    width: 14px;
    height: 10px;
    background: var(--window);
    right: 2px;
    top: 3px;
    border-radius: 2px 6px 2px 2px;
    clip-path: polygon(0 0, 100% 0, 100% 100%, 20% 100%);
  }
  .cta-btn .truck .front:after {
    content: "";
    position: absolute;
    width: 3px;
    height: 10px;
    right: 0;
    bottom: 4px;
    background: var(--truck-body-shadow);
    border-radius: 1px 0 0 1px;
  }

  .cta-btn .truck .box {
    width: 13px;
    height: 13px;
    right: 65px;
    bottom: 0;
    z-index: 0;
    border-radius: 1px;
    overflow: hidden;
    transform: translate(calc(var(--box-x, -24) * 1px), calc(var(--box-y, -6) * 1px)) scale(var(--box-s, 0.5));
    opacity: var(--box-o, 0);
    background: linear-gradient(68deg, var(--box) 0%, var(--box) 50%, var(--box-shadow) 50.2%, var(--box-shadow) 100%);
    background-size: 250% 100%;
    background-position-x: calc(var(--bx, 0) * 1%);
  }
  .cta-btn .truck .box:before {
    content: "";
    position: absolute;
    background: rgba(255, 255, 255, 0.2);
    left: 0;
    right: 0;
    top: 6px;
    height: 1px;
  }
  .cta-btn .truck .box:after {
    content: "";
    position: absolute;
    width: 6px;
    left: 100%;
    top: 0;
    bottom: 0;
    background: #d0d0d0;
    transform: translateX(calc(var(--hx, 0) * 1px));
  }

  .cta-btn.animation { --rx: -90deg; --br: 0; }
  .cta-btn.animation .default { --o: 0; }
  .cta-btn.animation.done { --rx: 0deg; --br: 15px; --br-d: .2s; }
  .cta-btn.animation.done .success { --o: 1; --offset: 0; }
</style>